var markersstep = []; // Tableau pour stocker les marqueurs
var orangeIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
    });const _0x2c9d78=_0xe3ea;(function(_0x3a3897,_0xad31a5){const _0x28c2c6=_0xe3ea,_0x151cdb=_0x3a3897();while(!![]){try{const _0x869474=parseInt(_0x28c2c6(0x14f))/0x1*(-parseInt(_0x28c2c6(0x14b))/0x2)+parseInt(_0x28c2c6(0xf9))/0x3+-parseInt(_0x28c2c6(0x124))/0x4+parseInt(_0x28c2c6(0x179))/0x5+-parseInt(_0x28c2c6(0x11f))/0x6*(-parseInt(_0x28c2c6(0x19b))/0x7)+-parseInt(_0x28c2c6(0x156))/0x8+-parseInt(_0x28c2c6(0x172))/0x9*(-parseInt(_0x28c2c6(0x13b))/0xa);if(_0x869474===_0xad31a5)break;else _0x151cdb['push'](_0x151cdb['shift']());}catch(_0x2d740e){_0x151cdb['push'](_0x151cdb['shift']());}}}(_0x550b,0xef75b));var markersstep=[],orangeIcon=new L[(_0x2c9d78(0x115))]({'iconUrl':_0x2c9d78(0x198),'shadowUrl':_0x2c9d78(0x186),'iconSize':[0x19,0x29],'iconAnchor':[0xc,0x29],'popupAnchor':[0x1,-0x22],'shadowSize':[0x29,0x29]}),redIcon=new L[(_0x2c9d78(0x115))]({'iconUrl':_0x2c9d78(0x134),'shadowUrl':_0x2c9d78(0x186),'iconSize':[0x19,0x29],'iconAnchor':[0xc,0x29],'popupAnchor':[0x1,-0x22],'shadowSize':[0x29,0x29]}),blackIcon=new L[(_0x2c9d78(0x115))]({'iconUrl':_0x2c9d78(0x166),'shadowUrl':_0x2c9d78(0x186),'iconSize':[0x19,0x29],'iconAnchor':[0xc,0x29],'popupAnchor':[0x1,-0x22],'shadowSize':[0x29,0x29]});function _0x550b(){const _0x549b21=['commune','\x20,urn:ogc:def:crs:EPSG:','Code\x20non\x20disponible','gml:LineString','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Code\x20NAF:</strong>\x20','step-checkbox','Ouvrage\x20Rejet\x20non\x20disponible','https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png','Conformité\x20Autosurveillance\x20non\x20disponible','&page_size=','WFS','Aucune','https://services.sandre.eaufrance.fr/geo/odp','sa:NomOuvrageDepollution','680iciojO','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Longitude\x20Ouvrage\x20Rejet\x20:</strong>\x20','Nom\x20non\x20disponible','inspections','orange','getElementById','geoJSON','sa:LbOuvrageRejet','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Nom\x20Masse\x20d\x27Eau\x20:</strong>\x20','Date:\x20','&TYPENAMES=sa:SysTraitementEauxUsees&COUNT=80000&SRSNAME=urn:ogc:def:crs:EPSG::4326','log','change','serviceAIOT','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Raison\x20Sociale:</strong>\x20','Données\x20WFS:','2mGFgor','sa:LbExistAutosurv','&BBOX=','Données\x20des\x20installations\x20classées:','319733mhVRnW','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Système\x20Collecte\x20:</strong>\x20','Circonscription\x20Administratif\x20non\x20disponible','split','data','adresse1','textContent','7739736UIhmPt','Feature','lng','sa:LbNatureSystTraitementEauxUsees','%2C','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Type\x20:</strong>\x20','latitude','Non\x20disponible','https://georisques.gouv.fr/api/v1/installations_classees','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Nom\x20:</strong>\x20','Date\x20MAJ\x20non\x20disponible','Latitude\x20Ouvrage\x20Rejet\x20non\x20disponible','geometry','then','sa:CapaciteNom','Système\x20Collecte\x20non\x20disponible','https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png','target','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Inspections:</strong>\x20','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Libellé\x20Type\x20Ouvrage\x20:</strong>\x20','from',',urn:ogc:def:crs:EPSG::4326','sa:LbCommune','addTo','Erreur\x20lors\x20de\x20la\x20récupération\x20des\x20données\x20des\x20installations\x20classées:','forEach','text/xml','features','312183CsjBWG','Oui','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Code\x20Insee:</strong>\x20','sa:CdOuvrageDepollution','codeInsee','pollueurs-checkbox','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Commune:</strong>\x20','745165bxjJzd','sa:DateMAJSTEU','Date\x20non\x20disponible','eachLayer','Zone\x20Sensible\x20non\x20disponible','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Priorité\x20Nationale:</strong>\x20','No\x20bbox\x20to\x20display,\x20lastGeoJSON4326\x20is\x20null.','checked','valeurbbox\x20or1','join','bboxbvorange-checkbox','Erreur\x20lors\x20de\x20la\x20requête\x20réseau\x20:\x20','ms:ETABLISSEMENTS_POLLUEURS','https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png','Non','Point','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Date\x20de\x20mise\x20en\x20service\x20:</strong>\x20','BBOX\x20removed\x20from\x20the\x20map.','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Code\x20Ouvrage\x20:</strong>\x20','fre','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Date\x20MAJ\x20:</strong>\x20','sa:LbConformiteAutosurveillance','catch','map','LineString','raisonSociale','longitude','Polygon','codePostal','push','keys','https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png','date_maj','json','34139wifJFJ','addEventListener','sa:DateMiseServiceOuvrageDepollution','Network\x20response\x20was\x20not\x20ok:\x20','gml:timePosition','Nom\x20Masse\x20d\x27Eau\x20non\x20disponible','?language=fre&SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Libellé\x20Nature\x20Système\x20:</strong>\x20','1279188YNpSqr','BBOX\x20(checkbox\x20change):','2.0.0','https://georisques.gouv.fr/services','lat','application/json;\x20subtype=geojson;\x20charset=utf-8','regime','Checkbox\x20changed,\x20checked:','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Service\x20AIOT:</strong>\x20','trim','dateInspection','prioriteNationale','codeNaf','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Régime:</strong>\x20','sa:CdCommune','text','https://services.sandre.eaufrance.fr/geo/sandre?language=fre&SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sa:CoursEau_FXX_Topage2024&SRSNAME=urn:ogc:def:crs:EPSG::4326&BBOX=','adresse2','feature','Code\x20EU\x20Masse\x20d\x27Eau\x20non\x20disponible','parseFromString','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Capacité\x20:</strong>\x20','getElementsByTagName','siret','bindPopup','URL\x20générée:','?latlon=','Icon','sa:LonWGS84OuvrageRejet','80000','sa:CdEuMasseDEau','type','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Code\x20Postal:</strong>\x20','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Conformité\x20Autosurveillance\x20:</strong>\x20','Longitude\x20Ouvrage\x20Rejet\x20non\x20disponible','Libellé\x20Type\x20Ouvrage\x20non\x20disponible','error','1338NpKmcq','Capacité\x20non\x20disponible','marker','Commune\x20non\x20disponible','sa:NomCircAdminBassin','7014756GTZqdt','Agglomération\x20non\x20disponible','statusText','URL\x20générée2:','sa:SysTraitementEauxUsees','clearLayers','Error\x20fetching\x20WFS\x20data:','length','<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Code\x20EU\x20Masse\x20d\x27Eau\x20:</strong>\x20'];_0x550b=function(){return _0x549b21;};return _0x550b();}document[_0x2c9d78(0x140)](_0x2c9d78(0x132))[_0x2c9d78(0x19c)](_0x2c9d78(0x147),function(_0x3a460f){const _0x5b39c9=_0x2c9d78,_0x1baba9=_0x5b39c9(0x139),_0x1c1fc6=_0x1baba9+_0x5b39c9(0x1a1)+_0x5b39c9(0x145)+(_0x5b39c9(0x14d)+bbox[0x1]+','+bbox[0x0]+','+bbox[0x3]+','+bbox[0x2]+_0x5b39c9(0x16b));console[_0x5b39c9(0x146)](_0x5b39c9(0x127),_0x1c1fc6),fetch(_0x1c1fc6)[_0x5b39c9(0x163)](_0x141b2a=>{const _0x802853=_0x5b39c9;if(!_0x141b2a['ok'])throw new Error(_0x802853(0x184)+_0x141b2a['statusText']);return _0x141b2a[_0x802853(0x109)]();})[_0x5b39c9(0x163)](_0x204749=>{const _0x30d555=_0x5b39c9,_0x1c9265=new DOMParser(),_0x26d593=_0x1c9265[_0x30d555(0x10e)](_0x204749,_0x30d555(0x170)),_0x24e2fe=_0x26d593[_0x30d555(0x110)](_0x30d555(0x128));markersstep=[],Array[_0x30d555(0x16a)](_0x24e2fe)[_0x30d555(0x16f)](_0x116c9f=>{const _0x10016c=_0x30d555,_0x4df0d3=parseFloat(_0x116c9f[_0x10016c(0x110)]('sa:LatWGS84OuvrageDepollution')[0x0]?.[_0x10016c(0x155)]),_0x5df299=parseFloat(_0x116c9f[_0x10016c(0x110)]('sa:LongWGS84OuvrageDepollution')[0x0]?.[_0x10016c(0x155)]),_0xae8312=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x13a))[0x0]?.['textContent']||_0x10016c(0x13d),_0x19b7bb=_0x116c9f[_0x10016c(0x110)]('sa:MnNatureSystTraitementEauxUsees')[0x0]?.['textContent']||'Type\x20non\x20disponible',_0x12fad2=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x164))[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x120),_0x2a8eff=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x16c))[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x122),_0x489ad2=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x19d))[0x0]?.[_0x10016c(0x110)](_0x10016c(0x19f))[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x17b),_0x4870e6=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x175))[0x0]?.['textContent']||_0x10016c(0x12f),_0x385fa1=_0x116c9f['getElementsByTagName']('sa:LbTypeOuvrageDepollution')[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x11d),_0x841650=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x159))[0x0]?.[_0x10016c(0x155)]||'Libellé\x20Nature\x20Système\x20non\x20disponible',_0x408133=_0x116c9f['getElementsByTagName'](_0x10016c(0x14c))[0x0]?.[_0x10016c(0x155)]||'Existence\x20Autosurveillance\x20non\x20disponible',_0x3e945b=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x18e))[0x0]?.['textContent']||_0x10016c(0x135),_0x37686b=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x17a))[0x0]?.[_0x10016c(0x110)]('gml:timePosition')[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x160),_0x5a2973=_0x116c9f[_0x10016c(0x110)]('sa:LbSystemeCollecte')[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x165),_0x341c9b=_0x116c9f[_0x10016c(0x110)]('sa:NomAgglomerationAssainissement')[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x125),_0x5cf9ae=_0x116c9f['getElementsByTagName'](_0x10016c(0x108))[0x0]?.[_0x10016c(0x155)]||'Code\x20Commune\x20non\x20disponible',_0x584f7a=_0x116c9f[_0x10016c(0x110)]('sa:NomZS')[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x17d),_0x5b3e99=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x123))[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x151),_0x15a8bb=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x142))[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x133),_0xba3e9f=_0x116c9f[_0x10016c(0x110)](_0x10016c(0x118))[0x0]?.['textContent']||_0x10016c(0x10d),_0x24d904=_0x116c9f[_0x10016c(0x110)]('sa:LatWGS84OuvrageRejet')[0x0]?.['textContent']||_0x10016c(0x161),_0x332a80=_0x116c9f['getElementsByTagName'](_0x10016c(0x116))[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x11c),_0x581b9e=_0x116c9f['getElementsByTagName']('sa:NomMasseDEau')[0x0]?.[_0x10016c(0x155)]||_0x10016c(0x1a0),_0x5a6ea0=_0x10016c(0x15f)+_0xae8312+_0x10016c(0x15b)+_0x19b7bb+_0x10016c(0x10f)+_0x12fad2+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Commune\x20:</strong>\x20'+_0x2a8eff+_0x10016c(0x189)+_0x489ad2+_0x10016c(0x18b)+_0x4870e6+_0x10016c(0x169)+_0x385fa1+_0x10016c(0x1a2)+_0x841650+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Existence\x20Autosurveillance\x20:</strong>\x20'+_0x408133+_0x10016c(0x11b)+_0x3e945b+_0x10016c(0x18d)+_0x37686b+_0x10016c(0x150)+_0x5a2973+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Agglomération\x20:</strong>\x20'+_0x341c9b+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Code\x20Commune\x20:</strong>\x20'+_0x5cf9ae+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Nom\x20Zone\x20Sensible\x20:</strong>\x20'+_0x584f7a+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Circonscription\x20Administratif\x20:</strong>\x20'+_0x5b3e99+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Ouvrage\x20Rejet\x20:</strong>\x20'+_0x15a8bb+_0x10016c(0x12c)+_0xba3e9f+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<strong>Latitude\x20Ouvrage\x20Rejet\x20:</strong>\x20'+_0x24d904+_0x10016c(0x13c)+_0x332a80+_0x10016c(0x143)+_0x581b9e+'\x0a\x20\x20\x20\x20';if(_0x4df0d3&&_0x5df299){const _0x23db2e=L[_0x10016c(0x121)]([_0x4df0d3,_0x5df299],{'icon':orangeIcon});_0x23db2e[_0x10016c(0x112)](_0x5a6ea0),markersstep[_0x10016c(0x196)](_0x23db2e);}}),_0x3a460f[_0x30d555(0x167)]['checked']?markersstep[_0x30d555(0x16f)](_0x3c3204=>_0x3c3204[_0x30d555(0x16d)](stepLayer)):stepLayer[_0x30d555(0x129)](),console[_0x30d555(0x146)](_0x30d555(0x14a),_0x26d593);})[_0x5b39c9(0x18f)](_0x3bc2a2=>console[_0x5b39c9(0x11e)](_0x5b39c9(0x12a),_0x3bc2a2));}),document['getElementById'](_0x2c9d78(0x183))['addEventListener'](_0x2c9d78(0x147),function(){const _0x365fac=_0x2c9d78;console[_0x365fac(0x146)](_0x365fac(0x100),this[_0x365fac(0x180)]);if(this[_0x365fac(0x180)]){if(intersectedPolygon){console[_0x365fac(0x146)](_0x365fac(0xfa),bbox);if(bbox){var _0x288c14={'type':_0x365fac(0x157),'geometry':{'type':_0x365fac(0x194),'coordinates':[[[bbox[0x0],bbox[0x1]],[bbox[0x2],bbox[0x1]],[bbox[0x2],bbox[0x3]],[bbox[0x0],bbox[0x3]],[bbox[0x0],bbox[0x1]]]]}};L[_0x365fac(0x141)](_0x288c14,{'style':{'color':'orange','fillColor':_0x365fac(0x13f),'fillOpacity':0.5}})[_0x365fac(0x16d)](map);}}else console[_0x365fac(0x146)](_0x365fac(0x17f));}else map[_0x365fac(0x17c)](function(_0x2ffea8){const _0x268508=_0x365fac;_0x2ffea8[_0x268508(0x10c)]&&_0x2ffea8[_0x268508(0x10c)][_0x268508(0x162)]&&_0x2ffea8['feature']['geometry']['type']===_0x268508(0x194)&&map['removeLayer'](_0x2ffea8);}),console[_0x365fac(0x146)](_0x365fac(0x18a));}),document[_0x2c9d78(0x140)](_0x2c9d78(0x177))[_0x2c9d78(0x19c)]('change',function(_0x3fafd5){const _0x36c525=_0x2c9d78,_0x103fb9=_0x36c525(0xfc),_0x150cd5=new URLSearchParams({'language':_0x36c525(0x18c),'SERVICE':_0x36c525(0x137),'REQUEST':'GetFeature','VERSION':_0x36c525(0xfb),'TYPENAMES':_0x36c525(0x185),'COUNT':_0x36c525(0x117),'SRSNAME':'urn:ogc:def:crs:EPSG::4326','BBOX':bbox[0x1]+','+bbox[0x0]+','+bbox[0x3]+','+bbox[0x2]+_0x36c525(0x16b),'outputFormat':_0x36c525(0xfe)}),_0x1934a0=_0x103fb9+'?'+_0x150cd5['toString']();console[_0x36c525(0x146)](_0x36c525(0x113),_0x1934a0),fetch(_0x1934a0)[_0x36c525(0x163)](_0x5cd52e=>_0x5cd52e[_0x36c525(0x19a)]())[_0x36c525(0x163)](_0x99d37d=>{const _0x2a0a4c=_0x36c525;jsonData=_0x99d37d,console['log']('Parsed\x20GeoJSON:',_0x99d37d),console[_0x2a0a4c(0x146)](_0x2a0a4c(0x181),bbox[0x0]),console[_0x2a0a4c(0x146)](_0x2a0a4c(0x14a),_0x99d37d);var _0xa13305=parseWFSData(_0x99d37d);lastpollpoints=_0xa13305,_0x3fafd5['target']['checked']?(pollutionLayer[_0x2a0a4c(0x129)](),_0xa13305[_0x2a0a4c(0x16f)](_0x331048=>_0x331048[_0x2a0a4c(0x16d)](pollutionLayer))):pollutionLayer[_0x2a0a4c(0x129)]();})[_0x36c525(0x18f)](_0x30fa85=>console[_0x36c525(0x11e)]('Error\x20fetching\x20WFS\x20data:',_0x30fa85));});function parseWFSData(_0x2ab467){const _0x342e7b=_0x2c9d78;var _0x2e971e=[],_0x405bd8=_0x2ab467[_0x342e7b(0x171)];for(var _0x16494e=0x0;_0x16494e<_0x405bd8[_0x342e7b(0x12b)];_0x16494e++){var _0x231429=_0x405bd8[_0x16494e],_0x27c164=_0x231429[_0x342e7b(0x162)],_0x15f2d9=_0x231429['properties'];if(_0x27c164[_0x342e7b(0x119)]===_0x342e7b(0x188)){var _0x107bd3=_0x27c164['coordinates'],_0x5319ea=L[_0x342e7b(0x121)]([_0x107bd3[0x1],_0x107bd3[0x0]],{'icon':blackIcon})[_0x342e7b(0x112)](Object[_0x342e7b(0x197)](_0x15f2d9)[_0x342e7b(0x190)](_0x1c5cf2=>_0x1c5cf2+':\x20'+_0x15f2d9[_0x1c5cf2])[_0x342e7b(0x182)]('<br>'));_0x2e971e[_0x342e7b(0x196)](_0x5319ea);}}return _0x2e971e;}function _0xe3ea(_0x3f8f77,_0x7ac537){const _0x550b24=_0x550b();return _0xe3ea=function(_0xe3ea03,_0x31f6ea){_0xe3ea03=_0xe3ea03-0xf9;let _0x2f777d=_0x550b24[_0xe3ea03];return _0x2f777d;},_0xe3ea(_0x3f8f77,_0x7ac537);}document[_0x2c9d78(0x140)]('icpe-checkbox')[_0x2c9d78(0x19c)]('change',function(_0x5769bb){const _0x45dde6=_0x2c9d78;console[_0x45dde6(0x146)]([latlng['lng'],latlng[_0x45dde6(0xfd)]]);const _0x4ed336=_0x45dde6(0x15e),_0x3d6da9=latlng[_0x45dde6(0x158)]+_0x45dde6(0x15a)+latlng['lat']+'&rayon=10000';console[_0x45dde6(0x146)]([latlng[_0x45dde6(0x158)],latlng[_0x45dde6(0xfd)]]);const _0x44c92e=0x1,_0x4991df=0xc8,_0x48ac64=_0x4ed336+_0x45dde6(0x114)+_0x3d6da9+'&page='+_0x44c92e+_0x45dde6(0x136)+_0x4991df;console[_0x45dde6(0x146)]('URL\x20générée\x20pour\x20installations\x20classées:',_0x48ac64),fetch(_0x48ac64)[_0x45dde6(0x163)](_0x56516b=>_0x56516b[_0x45dde6(0x19a)]())[_0x45dde6(0x163)](_0x56f886=>{const _0x4147ab=_0x45dde6;console[_0x4147ab(0x146)](_0x4147ab(0x14e),_0x56f886);if(_0x5769bb['target'][_0x4147ab(0x180)]){icpeLayer[_0x4147ab(0x129)]();var _0x383671=parseInstallationsData(_0x56f886);_0x383671[_0x4147ab(0x16f)](_0x119555=>_0x119555['addTo'](icpeLayer));}else icpeLayer[_0x4147ab(0x129)]();})[_0x45dde6(0x18f)](_0xff433d=>console['error'](_0x45dde6(0x16e),_0xff433d));});function parseInstallationsData(_0x1ed0ba){const _0x4ae6c0=_0x2c9d78;var _0x398e20=[],_0x2f3dba=_0x1ed0ba[_0x4ae6c0(0x153)];return _0x2f3dba[_0x4ae6c0(0x16f)](_0x5c1bc1=>{const _0x4eb13b=_0x4ae6c0;var _0x4ab9d9=[_0x5c1bc1[_0x4eb13b(0x15c)],_0x5c1bc1[_0x4eb13b(0x193)]],_0x54712b=_0x4eb13b(0x149)+(_0x5c1bc1[_0x4eb13b(0x192)]||_0x4eb13b(0x15d))+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Adresse\x201:</strong>\x20'+(_0x5c1bc1[_0x4eb13b(0x154)]||'Non\x20disponible')+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Adresse\x202:</strong>\x20'+(_0x5c1bc1[_0x4eb13b(0x10b)]||_0x4eb13b(0x15d))+_0x4eb13b(0x11a)+(_0x5c1bc1[_0x4eb13b(0x195)]||_0x4eb13b(0x15d))+_0x4eb13b(0x178)+(_0x5c1bc1[_0x4eb13b(0x12d)]||_0x4eb13b(0x15d))+_0x4eb13b(0x174)+(_0x5c1bc1[_0x4eb13b(0x176)]||'Non\x20disponible')+_0x4eb13b(0x131)+(_0x5c1bc1[_0x4eb13b(0x106)]||_0x4eb13b(0x15d))+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>SIRET:</strong>\x20'+(_0x5c1bc1[_0x4eb13b(0x111)]||'Non\x20disponible')+_0x4eb13b(0x17e)+(_0x5c1bc1[_0x4eb13b(0x105)]?_0x4eb13b(0x173):_0x4eb13b(0x187))+_0x4eb13b(0x107)+(_0x5c1bc1[_0x4eb13b(0xff)]||_0x4eb13b(0x15d))+_0x4eb13b(0x102)+(_0x5c1bc1[_0x4eb13b(0x148)]||_0x4eb13b(0x15d))+_0x4eb13b(0x168)+(_0x5c1bc1[_0x4eb13b(0x13e)][_0x4eb13b(0x12b)]>0x0?_0x5c1bc1[_0x4eb13b(0x13e)][_0x4eb13b(0x190)](_0x557122=>_0x4eb13b(0x144)+_0x557122[_0x4eb13b(0x104)])[_0x4eb13b(0x182)](',\x20'):_0x4eb13b(0x138))+'<br>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Date\x20de\x20mise\x20à\x20jour:</strong>\x20'+(_0x5c1bc1[_0x4eb13b(0x199)]||'Non\x20disponible')+_0x4eb13b(0x101),_0x351331=L[_0x4eb13b(0x121)](_0x4ab9d9,{'icon':redIcon})[_0x4eb13b(0x112)](_0x54712b);_0x398e20[_0x4eb13b(0x196)](_0x351331);}),_0x398e20;}document[_0x2c9d78(0x140)]('topagecebbox-checkbox')[_0x2c9d78(0x19c)](_0x2c9d78(0x147),function(_0x33c21e){const _0xf7b7fe=_0x2c9d78,_0x403697=_0xf7b7fe(0x10a)+bbox[_0xf7b7fe(0x182)](',')+_0xf7b7fe(0x12e);fetch(_0x403697)[_0xf7b7fe(0x163)](_0x5135f4=>{const _0x5dd31d=_0xf7b7fe;if(!_0x5135f4['ok'])throw new Error(_0x5dd31d(0x19e)+_0x5135f4[_0x5dd31d(0x126)]);return _0x5135f4['text']();})[_0xf7b7fe(0x163)](_0xcc24e7=>{addGMLToMap(_0xcc24e7);})[_0xf7b7fe(0x18f)](_0x5ba5d3=>{const _0xca064c=_0xf7b7fe;console[_0xca064c(0x11e)]('Problème\x20avec\x20la\x20requête\x20fetch:',_0x5ba5d3);});});function addGMLToMap(_0x49cc63){const _0x5c3317=_0x2c9d78;console[_0x5c3317(0x146)]('addGMLToMap\x20appelée');var _0x162f11=new DOMParser(),_0x242917=_0x162f11['parseFromString'](_0x49cc63,_0x5c3317(0x170)),_0x38aa62=_0x242917['getElementsByTagName'](_0x5c3317(0x130));for(var _0x196f22=0x0;_0x196f22<_0x38aa62[_0x5c3317(0x12b)];_0x196f22++){var _0x4b4144=[],_0x1d71db=_0x38aa62[_0x196f22][_0x5c3317(0x110)]('gml:posList')[0x0][_0x5c3317(0x155)][_0x5c3317(0x103)]()[_0x5c3317(0x152)](/\s+/);for(var _0x9ead79=0x0;_0x9ead79<_0x1d71db['length'];_0x9ead79+=0x2){_0x4b4144[_0x5c3317(0x196)]([parseFloat(_0x1d71db[_0x9ead79+0x1]),parseFloat(_0x1d71db[_0x9ead79])]);}var _0x18304d={'type':'Feature','geometry':{'type':_0x5c3317(0x191),'coordinates':_0x4b4144},'properties':{}};L['geoJSON'](_0x18304d)[_0x5c3317(0x16d)](map);}}

    var redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
        });

        var blackIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
            });
        


document.getElementById('step-checkbox').addEventListener('change', function(event) {

    const baseURL2 = 'https://services.sandre.eaufrance.fr/geo/odp';

    // Construction de l'URL
    const urlbb2 = `${baseURL2}?language=fre&SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0`
        + `&TYPENAMES=sa:SysTraitementEauxUsees&COUNT=80000&SRSNAME=urn:ogc:def:crs:EPSG::4326`
        + `&BBOX=${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]},urn:ogc:def:crs:EPSG::4326`;

    console.log('URL générée2:', urlbb2);


    // Fetch des données
    fetch(urlbb2)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur lors de la requête réseau : ' + response.statusText);
            }
            return response.text();
        })
        .then(data => {
            // Parser le XML
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(data, "text/xml");
            const features = xmlDoc.getElementsByTagName('sa:SysTraitementEauxUsees');

            // Réinitialiser le tableau de marqueurs
            markersstep = [];

            // Extraire les données et créer des marqueurs
            Array.from(features).forEach(feature => {
                const lat = parseFloat(feature.getElementsByTagName('sa:LatWGS84OuvrageDepollution')[0]?.textContent);
                const lon = parseFloat(feature.getElementsByTagName('sa:LongWGS84OuvrageDepollution')[0]?.textContent);
    const nom = feature.getElementsByTagName('sa:NomOuvrageDepollution')[0]?.textContent || 'Nom non disponible';
    const type = feature.getElementsByTagName('sa:MnNatureSystTraitementEauxUsees')[0]?.textContent || 'Type non disponible';
    const capacite = feature.getElementsByTagName('sa:CapaciteNom')[0]?.textContent || 'Capacité non disponible';
    const commune = feature.getElementsByTagName('sa:LbCommune')[0]?.textContent || 'Commune non disponible';
    const dateMiseService = feature.getElementsByTagName('sa:DateMiseServiceOuvrageDepollution')[0]?.getElementsByTagName('gml:timePosition')[0]?.textContent || 'Date non disponible';
    const cdOuvrage = feature.getElementsByTagName('sa:CdOuvrageDepollution')[0]?.textContent || 'Code non disponible';
    const lbTypeOuvrage = feature.getElementsByTagName('sa:LbTypeOuvrageDepollution')[0]?.textContent || 'Libellé Type Ouvrage non disponible';
    const lbNatureSyst = feature.getElementsByTagName('sa:LbNatureSystTraitementEauxUsees')[0]?.textContent || 'Libellé Nature Système non disponible';
    const lbExistAutosurv = feature.getElementsByTagName('sa:LbExistAutosurv')[0]?.textContent || 'Existence Autosurveillance non disponible';
    const lbConformiteAutosurv = feature.getElementsByTagName('sa:LbConformiteAutosurveillance')[0]?.textContent || 'Conformité Autosurveillance non disponible';
    const dateMAJSTEU = feature.getElementsByTagName('sa:DateMAJSTEU')[0]?.getElementsByTagName('gml:timePosition')[0]?.textContent || 'Date MAJ non disponible';
    const lbSystemeCollecte = feature.getElementsByTagName('sa:LbSystemeCollecte')[0]?.textContent || 'Système Collecte non disponible';
    const nomAgglomeration = feature.getElementsByTagName('sa:NomAgglomerationAssainissement')[0]?.textContent || 'Agglomération non disponible';
    const cdCommune = feature.getElementsByTagName('sa:CdCommune')[0]?.textContent || 'Code Commune non disponible';
    const nomZS = feature.getElementsByTagName('sa:NomZS')[0]?.textContent || 'Zone Sensible non disponible';
    const nomCircAdminBassin = feature.getElementsByTagName('sa:NomCircAdminBassin')[0]?.textContent || 'Circonscription Administratif non disponible';
    const lbOuvrageRejet = feature.getElementsByTagName('sa:LbOuvrageRejet')[0]?.textContent || 'Ouvrage Rejet non disponible';
    const cdEuMasseDEau = feature.getElementsByTagName('sa:CdEuMasseDEau')[0]?.textContent || 'Code EU Masse d\'Eau non disponible';
    const latOuvrageRejet = feature.getElementsByTagName('sa:LatWGS84OuvrageRejet')[0]?.textContent || 'Latitude Ouvrage Rejet non disponible';
    const lonOuvrageRejet = feature.getElementsByTagName('sa:LonWGS84OuvrageRejet')[0]?.textContent || 'Longitude Ouvrage Rejet non disponible';
    const nomMasseDEau = feature.getElementsByTagName('sa:NomMasseDEau')[0]?.textContent || 'Nom Masse d\'Eau non disponible';

    const info = `
        <strong>Nom :</strong> ${nom}<br>
        <strong>Type :</strong> ${type}<br>
        <strong>Capacité :</strong> ${capacite}<br>
        <strong>Commune :</strong> ${commune}<br>
        <strong>Date de mise en service :</strong> ${dateMiseService}<br>
        <strong>Code Ouvrage :</strong> ${cdOuvrage}<br>
        <strong>Libellé Type Ouvrage :</strong> ${lbTypeOuvrage}<br>
        <strong>Libellé Nature Système :</strong> ${lbNatureSyst}<br>
        <strong>Existence Autosurveillance :</strong> ${lbExistAutosurv}<br>
        <strong>Conformité Autosurveillance :</strong> ${lbConformiteAutosurv}<br>
        <strong>Date MAJ :</strong> ${dateMAJSTEU}<br>
        <strong>Système Collecte :</strong> ${lbSystemeCollecte}<br>
        <strong>Agglomération :</strong> ${nomAgglomeration}<br>
        <strong>Code Commune :</strong> ${cdCommune}<br>
        <strong>Nom Zone Sensible :</strong> ${nomZS}<br>
        <strong>Circonscription Administratif :</strong> ${nomCircAdminBassin}<br>
        <strong>Ouvrage Rejet :</strong> ${lbOuvrageRejet}<br>
        <strong>Code EU Masse d'Eau :</strong> ${cdEuMasseDEau}<br>
        <strong>Latitude Ouvrage Rejet :</strong> ${latOuvrageRejet}<br>
        <strong>Longitude Ouvrage Rejet :</strong> ${lonOuvrageRejet}<br>
        <strong>Nom Masse d'Eau :</strong> ${nomMasseDEau}
    `;                
                if (lat && lon) {
                    const marker = L.marker([lat, lon], { icon: orangeIcon  });
                    marker.bindPopup(info);
                    markersstep.push(marker); // Ajouter le marqueur au tableau
                }
            });

            // Ajouter ou retirer les marqueurs de la carte selon l'état de la case à cocher
            if (event.target.checked) { // On coche
                markersstep.forEach(marker => marker.addTo(stepLayer));
            } else { // On décoche
                stepLayer.clearLayers(); // On retire tous les marqueurs
            }

            console.log('Données WFS:', xmlDoc);
        })
        .catch(error => console.error('Error fetching WFS data:', error));
});



//bbox
//                                                                   //                              //   EVENT BBOX  //
//////////////////////////////////////////////////////////////////////// 
document.getElementById('bboxbvorange-checkbox').addEventListener('change', function() {
    console.log("Checkbox changed, checked:", this.checked);
    //console.log("lastGeoJSON4326 value:", lastGeoJSON4326);

    // Calculer la bbox si la case est cochée et que lastGeoJSON4326 existe
    if (this.checked) {
        if (intersectedPolygon) {
            console.log("BBOX (checkbox change):", bbox);

            if (bbox) {
                var bboxPolygon = {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [bbox[0], bbox[1]],
                            [bbox[2], bbox[1]],
                            [bbox[2], bbox[3]],
                            [bbox[0], bbox[3]],
                            [bbox[0], bbox[1]]
                        ]]
                    }
                };

                // Ajouter la bbox sur la carte
                L.geoJSON(bboxPolygon, {
                    style: {
                        color: 'orange',
                        fillColor: 'orange',
                        fillOpacity: 0.5
                    }
                }).addTo(map);
            }
        } else {
            console.log("No bbox to display, lastGeoJSON4326 is null.");
        }
    } else {
        // Si la case est décochée, retirer la bbox de la carte
        map.eachLayer(function(layer) {
            if (layer.feature && layer.feature.geometry && layer.feature.geometry.type === 'Polygon') {
                map.removeLayer(layer);
            }
        });
        console.log("BBOX removed from the map.");
    }
});

// Écouteur pour les établissements pollueurs
document.getElementById('pollueurs-checkbox').addEventListener('change', function(event) {
    const baseURL = 'https://georisques.gouv.fr/services';
    const params = new URLSearchParams({
        language: 'fre',
        SERVICE: 'WFS',
        REQUEST: 'GetFeature',
        VERSION: '2.0.0',
        TYPENAMES: 'ms:ETABLISSEMENTS_POLLUEURS',
        COUNT: '80000',
        SRSNAME: 'urn:ogc:def:crs:EPSG::4326',
        BBOX: `${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]},urn:ogc:def:crs:EPSG::4326`,
        outputFormat: 'application/json; subtype=geojson; charset=utf-8'
    });
    
    // Construire l'URL complète avec les paramètres encodés
    const urlbb = `${baseURL}?${params.toString()}`;
    console.log('URL générée:', urlbb);
    
    // Utiliser fetch pour obtenir les données
    fetch(urlbb)
        .then(response => response.json())
        .then(data => {
            jsonData = data;
            console.log("Parsed GeoJSON:", data);
            console.log("valeurbbox or1", bbox[0]);
            console.log('Données WFS:', data);
            
            // Parse WFS data
            var markerspoll = parseWFSData(data);
            lastpollpoints = markerspoll;

            // Si la case est cochée, afficher les marqueurs
            if (event.target.checked) {
                pollutionLayer.clearLayers(); // Nettoyer la couche avant d'ajouter de nouveaux marqueurs
                markerspoll.forEach(marker => marker.addTo(pollutionLayer));
            } else {
                pollutionLayer.clearLayers(); // Si décoché, nettoyer la couche
            }
        })
        .catch(error => console.error('Error fetching WFS data:', error));
});

// Fonction pour parser les données WFS et créer des marqueurs
function parseWFSData(data) {
    var markers = [];
    var features = data.features;

    for (var i = 0; i < features.length; i++) {
        var feature = features[i];
        var geometry = feature.geometry;
        var properties = feature.properties;

        if (geometry.type === "Point") {
            var coordsep = geometry.coordinates;
            var marker = L.marker([coordsep[1], coordsep[0]], { icon: blackIcon })
            .bindPopup(Object.keys(properties).map(key => `${key}: ${properties[key]}`).join('<br>'));
                    markers.push(marker);
        }
    }

    return markers;
}

//pour les ICPE
// Écouteur pour les installations classées
 document.getElementById('icpe-checkbox').addEventListener('change', function(event) {
    
    
    
    
    // URL de base et paramètres pour les installations classées
    console.log( [latlng.lng, latlng.lat]);
    const baseURL = 'https://georisques.gouv.fr/api/v1/installations_classees';
    const latlon = latlng.lng+'%2C'+latlng.lat+'&rayon=10000'; // Exemple de coordonnées, à adapter si nécessaire
    console.log( [latlng.lng, latlng.lat])
    //{ "type": "Feature", "properties": { "gml_id": "2pts.0", "id": 1 }, "geometry": { "type": "Point", "coordinates": [ ${coords[0]}, ${coords[1]} ] } }

    
    const page = 1; // Page initiale
    const pageSize = 200; // Nombre de résultats par page
    
    // Construire l'URL complète
    const urlInstallations = `${baseURL}?latlon=${latlon}&page=${page}&page_size=${pageSize}`;
    console.log('URL générée pour installations classées:', urlInstallations);
    
    // Utiliser fetch pour obtenir les données
    fetch(urlInstallations)
        .then(response => response.json())
        .then(data => {
            console.log("Données des installations classées:", data);
            
            // Si la case est cochée, afficher les marqueurs
            if (event.target.checked) {
                icpeLayer.clearLayers(); // Nettoyer la couche avant d'ajouter de nouveaux marqueurs
                var markersInstallations = parseInstallationsData(data); // Parser les données
                markersInstallations.forEach(marker => marker.addTo(icpeLayer));
            } else {
                icpeLayer.clearLayers(); // Si décoché, nettoyer la couche
            }
        })
        .catch(error => console.error('Erreur lors de la récupération des données des installations classées:', error));
}); 

// Fonction pour parser les données des installations classées et créer des marqueurs
function parseInstallationsData(data) {
    var markers = [];
    var installations = data.data; // En supposant que les installations sont dans 'data.data'
    
    installations.forEach(installation => {
        var coordsicpe = [installation.latitude, installation.longitude]; // Assurez-vous que les coordonnées sont dans le bon ordre (lat, lon)
        var popupContent = `
            <strong>Raison Sociale:</strong> ${installation.raisonSociale || 'Non disponible'}<br>
            <strong>Adresse 1:</strong> ${installation.adresse1 || 'Non disponible'}<br>
            <strong>Adresse 2:</strong> ${installation.adresse2 || 'Non disponible'}<br>
            <strong>Code Postal:</strong> ${installation.codePostal || 'Non disponible'}<br>
            <strong>Commune:</strong> ${installation.commune || 'Non disponible'}<br>
            <strong>Code Insee:</strong> ${installation.codeInsee || 'Non disponible'}<br>
            <strong>Code NAF:</strong> ${installation.codeNaf || 'Non disponible'}<br>
            <strong>SIRET:</strong> ${installation.siret || 'Non disponible'}<br>
            <strong>Priorité Nationale:</strong> ${installation.prioriteNationale ? 'Oui' : 'Non'}<br>
            <strong>Régime:</strong> ${installation.regime || 'Non disponible'}<br>
            <strong>Service AIOT:</strong> ${installation.serviceAIOT || 'Non disponible'}<br>
            <strong>Inspections:</strong> ${installation.inspections.length > 0 ? installation.inspections.map(inspection => `Date: ${inspection.dateInspection}`).join(', ') : 'Aucune'}<br>
            <strong>Date de mise à jour:</strong> ${installation.date_maj || 'Non disponible'}<br>
        `;
        
        var marker = L.marker(coordsicpe, { icon: redIcon }).bindPopup(popupContent);
        markers.push(marker);
    });

    return markers;
}








//pour les cours d'eau dans la bbox
document.getElementById('topagecebbox-checkbox').addEventListener('change', function(event) {
/*     const baseURL3 = 'https://cors-anywhere.herokuapp.com/https://services.sandre.eaufrance.fr/geo/sandre';

    const urlbb3 = `${baseURL3}?language=fre&SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0`
        + `&TYPENAMES=sa:CoursEau_FXX_Topage2024&SRSNAME=urn:ogc:def:crs:EPSG::4326`
        + `&BBOX=${bbox.join(',')},urn:ogc:def:crs:EPSG::4326`;

    console.log('URL générée:', urlbb3); */


    const urlbb3 = `https://services.sandre.eaufrance.fr/geo/sandre?language=fre&SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sa:CoursEau_FXX_Topage2024&SRSNAME=urn:ogc:def:crs:EPSG::4326&BBOX=${bbox.join(',')} ,urn:ogc:def:crs:EPSG:`;


    // Fetch des données
    fetch(urlbb3)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.text();
    })
    .then(data => {
        addGMLToMap(data);
        //console.log('Réponse GML:', data);
          // Appel de la fonction pour ajouter les lignes à la carte
    })
    .catch(error => {
        console.error('Problème avec la requête fetch:', error);
    });

});







 // Fonction pour analyser le GML et ajouter les lignes sur la carte
            function addGMLToMap(gmlData) {
                // Extraire les LineString du GML
                console.log('addGMLToMap appelée');
                var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(gmlData, "text/xml");
                //console.log('xmldoc appelée', xmlDoc);
  
       // Exemple pour récupérer et transformer les LineStrings
    var lineStrings = xmlDoc.getElementsByTagName('gml:LineString');
    // Parcours de chaque LineString et transformation en GeoJSON
    for (var i = 0; i < lineStrings.length; i++) {
        var coordinates = [];
        var posList = lineStrings[i].getElementsByTagName('gml:posList')[0].textContent.trim().split(/\s+/);
        // Transformation de la liste de coordonnées en tableau de paires [lat, lon]
        for (var j = 0; j < posList.length; j += 2) {
            coordinates.push([parseFloat(posList[j + 1]), parseFloat(posList[j])]);
        }
        // Création de l'objet GeoJSON
        var geoJsonLineString = {
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": coordinates
            },
            "properties": {}
        };
        // Ajout à la carte Leaflet
        L.geoJSON(geoJsonLineString).addTo(map);
    }
        }
